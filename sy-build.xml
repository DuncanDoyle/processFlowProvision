<project name="sy-build" >

    <target name="stop.standalone" >
        <fail unless="management.port" message="stop.standalone:  need to pass 'management.port' property" />
        <if>
            <not><isset property="server.ip.address"/></not>
            <then><property name="server.ip.address" value="${os.hostname}" /></then>
        </if>
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/local.jboss.standalone.sh"/>
           <arg value="stop"/>
           <arg value="-jbossHome=${jboss.home}"/>
           <arg value="-hostName=${server.ip.address}"/>
           <arg value="-cliPort=${management.port}"/>
        </exec>
    </target>
    <target name="start.standalone" >
        <fail unless="server.ip.address" message="start.standalone:  need to pass 'server.ip.address' property" />
        <fail unless="port.offset" message="start.standalone:  need to pass 'port.offset' property" />
        <fail unless="new.server.configuration" message="start.standalone:  need to pass 'new.server.configuration' property" />
        <fail unless="server.config.file.with.no.suffix" message="start.standalone:  need to pass 'server.config.file.with.no.suffix' property" />
        <var name="jbossModulePath" value="${jboss.home}/modules:${pfp.module.path}" />
        <if>
            <equals arg1="${org.jboss.processFlow.provision.switchyard}" arg2="true" />
            <then><var name="jbossModulePath" value="${jbossModulePath}:${sy.module.path}"/></then>
        </if>
        <exec executable="${development.base}/bin/local.jboss.standalone.sh" failonerror="true" >
            <arg value="start"/>
            <arg value="-jbossHome=${jboss.home}"/>
            <arg value="-hostName=${server.ip.address}"/>
            <arg value="-serverConfig=${server.config.file.with.no.suffix}.xml"/>
            <arg value="-jbossServerBaseDir=${new.server.configuration}"/>
            <arg value="-jbossSocketBindingPortOffset=${port.offset}"/>
            <arg value="-jbossModulePath=${jbossModulePath}"/>
            <arg value="-sleepSec=${sy.sleep.sec.after.start}"/>
        </exec>
    </target>

    <target name="local.sy.bounce.core" description="">
        <antcall target="stop.standalone" >
            <param name="server.ip.address" value="${sy.core.ip.address}"/>
            <param name="management.port" value="${sy.core.management.port}"/>
        </antcall>
        <antcall target="start.standalone" >
            <param name="port.offset" value="${sy.core.port.offset}"/>
            <param name="server.ip.address" value="${sy.core.ip.address}"/>
            <param name="new.server.configuration" value="${sy.core.server.config}"/>
            <param name="server.config.file.with.no.suffix" value="${sy.core.config.file.with.no.suffix}"/>
        </antcall>
    </target>

    <target name="local.sy.stop.core" description="">
        <antcall target="stop.standalone" >
            <param name="server.ip.address" value="${sy.core.ip.address}"/>
            <param name="management.port" value="${sy.core.management.port}"/>
        </antcall>
    </target>

    <target name="local.sy.start.core" description="">
        <antcall target="start.standalone" >
            <param name="port.offset" value="${sy.core.port.offset}"/>
            <param name="server.ip.address" value="${sy.core.ip.address}"/>
            <param name="new.server.configuration" value="${sy.core.server.config}"/>
            <param name="server.config.file.with.no.suffix" value="${sy.core.config.file.with.no.suffix}"/>
        </antcall>
    </target>

    <target name="local.sy.cli.gui" depends="" description="">
        <exec spawn="true" executable="${jboss.home}/bin/jboss-cli.sh">
            <arg value="--connect"/>
            <arg value="--controller=${sy.core.ip.address}:${sy.core.management.port}"/>
            <arg value="--gui"/>
        </exec>
    </target>


    <target name="clone.standalone" >
        <fail unless="new.server.configuration" message="clone.standalone:  need to pass 'new.server.configuration' property" />
        <delete dir="${jboss.home}/${new.server.configuration}" />
        <copy overwrite="true" todir="${jboss.home}/${new.server.configuration}">
            <fileset dir="${jboss.home}/standalone-orig" />
        </copy>
    </target>

    <!-- TO-DO -->
    <target name="provision.sy.with.jdbc" >
        <property name="db.script" value="${jdbc.module.name}-config-up.cli" />
        <antcall target="cli.batch">
            <param name="cli.source.dir" value="conf/standalone"/>
            <param name="cli.to.filter.and.execute" value="${db.script}"/>
            <param name="server.ip.address" value="${server.ip.address}"/>
            <param name="management.port" value="${management.port}"/>
            <param name="cli.fail.on.error" value="true"/>
        </antcall>
    </target>

    <target name="add.auth.props.to.standalone" >
        <fail unless="new.server.configuration" message="addUserRoleConfigs:  need to pass 'new.server.configuration' property" />
        <copy file="conf/jboss/application-roles.properties" todir="${jboss.home}/${new.server.configuration}/configuration" verbose="true" overwrite="true" />
        <copy file="conf/jboss/application-users.properties" todir="${jboss.home}/${new.server.configuration}/configuration" verbose="true" overwrite="true" />
        <copy file="conf/jboss/mgmt-users.properties" todir="${jboss.home}/${new.server.configuration}/configuration" verbose="true" overwrite="true" />
    </target>

</project>

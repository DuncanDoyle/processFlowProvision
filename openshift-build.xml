<project name="pfp-openshift" >

    <target name="openshift.provision.both" >
        <echo message="service repository = ${service.repository}" />
        <echo message="openshift.domain.name = ${openshift.domain.name}" />
        <antcall target="openshift.provision.pfp.core" />
    </target>

    <!--    
        pass following parameters to this target :
        1)  bounce.servers  :   optional 
    -->
    <target name="openshift.provision.pfp.core" >
        <delete dir="${openshift.pfpCore.app.location}" />
        <mkdir dir="${openshift.app.dir}" />
        <exec executable="git" failonerror="true" >
           <arg value="clone"/>
           <arg value="-o"/>
           <arg value="${openshift.domain.name}"/>
           <arg value="${openshift.pfpCore.git.url}"/>
           <arg value="${openshift.pfpCore.app.location}"/>
        </exec>
        <antcall target="openshift.deploy.jboss.modules" >
            <param name="app.location" value="${openshift.pfpCore.app.location}"/>
        </antcall>
        <antcall target="filter">
            <param name="source.dir" value="conf/openshift/pfpCore"/>
            <param name="dest.dir" value="${openshift.pfpCore.app.location}/.openshift"/>
        </antcall>
        <delete file="${openshift.pfpCore.app.location}/pom.xml" />
        <delete file="${openshift.pfpCore.app.location}/.openshift/markers/java7" />
        <antcall target="addUserRoleConfigs" >
            <param name="config.path" value="${openshift.pfpCore.app.location}/.openshift/config"/>
        </antcall>
        <copy todir="${openshift.pfpCore.app.location}/deployments" overwrite="true" >
            <fileset dir="${temp.pfp.services.dir}" >
                <include name="*.jar" />
                <include name="*.war" />
            </fileset>
        </copy>
        <antcall target="openshift.provision.brms.webs" />
        <!-- rsync to exploded web archives to :  ${openshift.jboss.cartridge.type}/tmp/deployments
            this directory will not get blown away when executing 'git push' on openshift app
        -->
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/openshift.sh"/>
           <arg value="openshiftRsync"/>
           <arg value="-localDir=${temp.brmsWebs.dir}/${console.server.name}/*"/>
           <arg value="-sshUrl=${openshift.pfpCore.ssh.url}"/>
           <arg value="-remoteDir=${openshift.jboss.cartridge.type}/tmp/deployments/${console.server.name}"/>
           <arg value="-rsyncDelete=true"/>
        </exec> 
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/openshift.sh"/>
           <arg value="openshiftRsync"/>
           <arg value="-localDir=${temp.brmsWebs.dir}/${console.name}/*"/>
           <arg value="-sshUrl=${openshift.pfpCore.ssh.url}"/>
           <arg value="-remoteDir=${openshift.jboss.cartridge.type}/tmp/deployments/${console.name}"/>
           <arg value="-rsyncDelete=true"/>
        </exec> 
        <if>
            <not><equals arg1="${bounce.servers}" arg2="false" /></not>
            <then>
                <exec executable="bash" failonerror="true" dir="." >
                <arg value="${development.base}/bin/openshift.sh"/>
                <arg value="push"/>
                <arg value="-localAppLocation=${openshift.pfpCore.app.location}"/>
                <arg value="-domainName=${openshift.domain.name}"/>
                </exec> 
            </then>
        </if>
    </target>

    <target name="openshift.provision.brms.webs" >
        <!-- rsync to exploded web archives to :  ${openshift.jboss.cartridge.type}/tmp/deployments
            this directory will not get blown away when executing 'git push' on openshift app
        -->
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/openshift.sh"/>
           <arg value="openshiftRsync"/>
           <arg value="-localDir=${temp.brmsWebs.dir}/${guvnor.name}/*"/>
           <arg value="-sshUrl=${openshift.pfpCore.ssh.url}"/>
           <arg value="-remoteDir=${openshift.jboss.cartridge.type}/tmp/deployments/${guvnor.name}"/>
           <arg value="-rsyncDelete=true"/>
        </exec> 
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/openshift.sh"/>
           <arg value="openshiftRsync"/>
           <arg value="-localDir=${temp.brmsWebs.dir}/${designer.name}/*"/>
           <arg value="-sshUrl=${openshift.pfpCore.ssh.url}"/>
           <arg value="-remoteDir=${openshift.jboss.cartridge.type}/tmp/deployments/${designer.name}"/>
           <arg value="-rsyncDelete=true"/>
        </exec> 
    </target>

    <target name="openshift.bounce.pfpCore" description="" >
        <antcall target="openshift.stop.jboss" >
            <param name="ssh.url" value="${openshift.pfpCore.ssh.url}"/>
        </antcall>
        <antcall target="openshift.start.jboss" >
            <param name="ssh.url" value="${openshift.pfpCore.ssh.url}"/>
        </antcall>
    </target>
    <target name="openshift.bounce.brmsWebs" description="" >
        <antcall target="openshift.stop.jboss" >
            <param name="ssh.url" value="${openshift.brmsWebs.ssh.url}"/>
        </antcall>
        <antcall target="openshift.start.jboss" >
            <param name="ssh.url" value="${openshift.brmsWebs.ssh.url}"/>
        </antcall>
    </target>

    <target name="openshift.stop.jboss" >
        <fail unless="ssh.url" message="stop.jboss:  need to pass 'ssh.url' property" />
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/openshift.sh"/>
           <arg value="stopJboss"/>
           <arg value="-sshUrl=${ssh.url}"/>
        </exec> 
    </target>
    <target name="openshift.start.jboss" >
        <fail unless="ssh.url" message="start.jboss:  need to pass 'ssh.url' property" />
        <exec executable="${development.base}/bin/openshift.sh" failonerror="true" >
            <arg value="startJboss"/>
            <arg value="-remoteJbossHome=${openshift.remote.jboss.home}"/>
            <arg value="-sshUrl=${ssh.url}"/>
        </exec> 
    </target>

    <target name="openshift.deploy.brms.webs" >
        <fail unless="ssh.url" message="os.deploy.brms.webs:  need to pass 'ssh.url' property" />
        <fail unless="remote.deployments.dir" message="os.deploy.brms.webs:  need to pass 'remote.deployments.dir' property" />
        <antcall target="create.brms.webs" />
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/openshift.sh"/>
           <arg value="copyFileToRemote"/>
           <arg value="-sshUrl=${ssh.url}"/>
           <arg value="-localDir=${temp.deployments.dir}"/>
           <arg value="-file=${designer.name}"/>
           <arg value="-remoteDir=${remote.deployments.dir}"/>
        </exec> 
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/openshift.sh"/>
           <arg value="copyFileToRemote"/>
           <arg value="-sshUrl=${ssh.url}"/>
           <arg value="-localDir=${temp.deployments.dir}"/>
           <arg value="-file=${guvnor.name}"/>
           <arg value="-remoteDir=${remote.deployments.dir}"/>
        </exec> 
    </target>
    <target name="openshift.refreshGuvnor" >
        <fail unless="ssh.url" message="os.refreshGuvnor:  need to pass 'ssh.url' property" />
        <fail unless="os.data.dir" message="os.refreshGuvnor:  need to pass 'os.data.dir' property" />
        <antcall target="filter">
            <param name="source.dir" value="conf/brmsWebs/drools-guvnor"/>
            <param name="file.name" value="repository.xml"/>
            <param name="dest.dir" value="target/tmp"/>
        </antcall>
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/openshift.sh"/>
           <arg value="refreshGuvnor"/>
           <arg value="-sshUrl=${ssh.url}"/>
           <arg value="-remoteDir=${os.data.dir}/guvnor"/>
        </exec> 

    </target>

    <target name="openshift.deploy.jboss.modules" >
        <fail unless="app.location" message="openshift.deploy.jboss.modules:  need to pass 'app.location' property" />
        <delete dir="${openshift.pfpCore.app.location}/.openshift/config/modules" />
        <antcall target="configure.jboss.modules" />
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/openshift.sh"/>
           <arg value="openshiftRsync"/>
           <arg value="-localDir=${temp.jboss.dir}/*"/>
           <arg value="-sshUrl=${openshift.pfpCore.ssh.url}"/>
           <arg value="-remoteDir=${openshift.jboss.cartridge.type}/tmp"/>
           <arg value="-rsyncDelete=true"/>
        </exec> 
    </target>

    <target name="openshift.provision.db" >
        <if>    
            <equals arg1="${jdbc.module.name}" arg2="postgresql" />
            <then><property name="command" value="executePostgresqlScript" /></then>
            <else><property name="command" value="executeMysqlScript" /></else>
        </if>   
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/openshift.sh"/>
           <arg value="${command}"/>
           <arg value="-serverIpAddr=${brmsWebs.db.ip.addr}"/>
           <arg value="-managementPort=3306"/>
           <arg value="-sshUrl=${brmsWebs.db.ssh.url}"/>
           <arg value="-user=${brmsWebs.db.root.user}"/>
           <arg value="-password=${brmsWebs.db.root.password}"/>
           <arg value="-localDir=conf/postgresql" />
           <arg value="-file=processFlowProvision.sql" />
           <arg value="-remoteDir=/tmp" />
        </exec> 
    </target>
    <target name="openshift.provision.accounts.with.pfp" description="" >
        <exec executable="bash" failonerror="true" dir="." >
           <arg value="${development.base}/bin/openshift.sh"/>
           <arg value="provisionAccountsWithPFP"/>
        </exec> 
    </target>

</project>

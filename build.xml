<project name="processFlowProvision" default="all" >

    <import file="config-build.xml" />
    <import file="openshift-build.xml" />
    <import file="classpath-build.xml" />
    <import file="interfaces/build.xml"/>
    <import file="common/build.xml"/>
    <import file="taskService/build.xml"/>
    <import file="knowledgeSessionService/build.xml"/>
    <import file="adminConsole/build.xml"/>
    <import file="bam/build.xml"/>
    <import file="privateServiceTaskRepo/build.xml"/>
    <import file="pfpServicesTest/build.xml"/>
    <import file="osProvision/build.xml"/>
    
    <target name="pfp.clean" description="" >
        <delete dir="${guvnor_repo_location}" />
        <delete dir="interfaces/${build.dir}" />
        <delete dir="common/${build.dir}" />
        <delete dir="taskService/${build.dir}" />
        <delete dir="knowledgeSessionService/${build.dir}" />
        <delete dir="adminConsole/${build.dir}" />
        <delete dir="bam/${build.dir}" />
        <delete dir="privateServiceTaskRepo/${build.dir}" />
        <delete dir="pfpServicesTest/${build.dir}" />
        <delete dir="osProvision/${build.dir}" />
        <delete dir="${install.home}/tmp" />
        <delete dir="${install.home}/pfp" />
        <delete dir="${temp.client.dir}" />
        <delete dir="${temp.distro.dir}" />
        <delete dir="${temp.brmsWebs.dir}" />
        <delete dir="${temp.jboss.dir}" />
        <delete dir="${distro.clean}" />
    </target>

    <target name="create.temp.client.dir" >
        <copy toDir="${temp.client.dir}" overwrite="true" >
            <fileset dir="${temp.pfp.lib.dir}" >
                <include name="processFlow-interfaces*.jar" />
            </fileset>
            <fileset dir="${jbpm.lib.path}" >
                <include name="jbpm-human-task-core*.jar" />
            </fileset>
            <fileset dir="${deps.lib.path}" >
                <include name="knowledge-api-*.jar" />
            </fileset>
        </copy>
    </target>

    <target name="pfp.distro" depends="all" description="" >

        <property name="distro.name" value="processFlow-bin-${brms.major.version}-${brms.minor.version}" />

        <copy file="config-build.xml" tofile="${temp.distro.dir}/build.xml" />
        <copy file="conf/pfp/build.properties" todir="${temp.distro.dir}" />
        <copy file="LICENSE.txt" todir="${temp.distro.dir}" />

        <zip destfile="${install.home}/${distro.name}.zip">
            <zipfileset dir="${temp.distro.dir}" prefix="${distro.name}" />
            <zipfileset dir="bin" prefix="${distro.name}/bin" filemode="755"/>
            <zipfileset dir="privateServiceTaskRepo" prefix="${distro.name}/privateServiceTaskRepo" />
            <zipfileset dir="${temp.client.dir}" prefix="${distro.name}/clientLibs" />
            <zipfileset dir="conf" prefix="${distro.name}/conf"/>
            <zipfileset dir="lib" prefix="${distro.name}/lib"/>
            <zipfileset dir="doc" prefix="${distro.name}/doc">
                <include name="ADMIN_GUIDE.txt" />
                <include name="release_notes.txt" />
            </zipfileset>
        </zip>
    </target>

    <target name="download.drools.guvnor">
        <echo message="Getting Drools Guvnor ..." />
        <get src="${drools.guvnor.url}" dest="${install.home}/lib/guvnor-distribution-wars-${drools.guvnor.version}-jboss-as-7.0.war"  skipexisting="true" />
    </target>
    <target name="download.designer" >
        <get src="${designer.url}/jbpm-designer-${designer.version}.war" dest="${install.home}/lib/jbpm-designer-${designer.version}.war"  skipexisting="true" />
    </target>
    <target name="download.jBPM.gwt-console">
        <property name="jBPM.url" value="file://${jbpm.source.dir}/jbpm-distribution/target" />
        <get src="${jBPM.url}/jbpm-${console.server.version}-gwt-console.zip" dest="${install.home}/lib/jbpm-${console.server.version}-gwt-console.zip"  skipexisting="true" />
    </target>
    <target name="download.birt.as7" >
        <mkdir dir="${install.home}/lib/reporting" />
        <get src="${birt.download.url.as7}" dest="${install.home}/lib/birt-runtime-${birt.version}.zip" skipexisting="true" />
        <get src="${jboss.nexus.url}/content/repositories/releases/org/jboss/bpm/report-core/1.3.0/report-core-1.3.0.jar" dest="${install.home}/lib/reporting" skipexisting="true" />
        <get src="${jboss.nexus.url}/content/repositories/releases/org/jboss/bpm/report-shared/1.3.0/report-shared-1.3.0.jar" dest="${install.home}/lib/reporting" skipexisting="true" />
    </target>


    <target name="download.community.jbpm.gwt.console" if="useCompiledJBPMLibs">
        <antcall target="download.jBPM.gwt-console" />
        <antcall target="download.birt.as7" />
    </target>
    <target name="download.community.guvnor.and.designer" if="useCompiledJBPMLibs">
        <antcall target="download.drools.guvnor" />
        <antcall target="download.designer" />
    </target>

    <target name="local.copy.community.jbpm.deps.to.modules" >
        <copy toDir="${temp.jboss.dir}/modules/org/jbpm/main" overwrite="true" >
            <fileset dir="${jbpm.source.dir}/jbpm-gwt/jbpm-gwt-shared/target/" >
                <include name="jbpm-gwt-shared-${jBPM.version}.jar" />
            </fileset>
        </copy>
    </target>

    <target name="mkPfpDirs">
        <mkdir dir="${temp.pfp.lib.dir}" />
        <mkdir dir="${temp.pfp.services.dir}" />
    </target>

    <target name="pfp.compile" description="" >
        <antcall target="setClasspath" />
        <antcall target="interfaces" />
        <antcall target="common" />
        <antcall target="bam" />
        <antcall target="knowledgeSessionService" />
        <antcall target="taskService" />
        <antcall target="adminConsole" />
    </target>

    <target name="all" >
        <antcall target="pfp.clean" />
        <mkdir dir="${install.home}/lib" />
        <antcall target="pfp.compile" />
        <antcall target="local.provision.brms.webs">
            <param name="refresh.master" value="true"/>
        </antcall>
        <antcall target="local.provision.pfp.core">
            <param name="refresh.master" value="false"/>
        </antcall>
        <antcall target="create.temp.client.dir" />
        <antcall target="clean.jbpm.install" />
    </target>
</project>

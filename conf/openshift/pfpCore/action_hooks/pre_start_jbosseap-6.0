#!/bin/bash

echo "** inside pre_start_jbosseap-6.0 "

# now increasing PermGen and lowering heap
export JAVA_OPTS="-client -Xmx664m -XX:MaxPermSize=256m -XX:+AggressiveOpts -Dorg.jboss.resolver.warning=true -Djava.net.preferIPv4Stack=true -Dfile.encoding=UTF-8 -Djava.net.preferIPv4Stack=true -Djboss.node.name=${OPENSHIFT_GEAR_DNS} -Djgroups.bind_addr=${OPENSHIFT_INTERNAL_IP}"
export JBOSS_MODULEPATH_ADD=$JBOSS_MODULEPATH:$HOME/${openshift.jboss.cartridge.type}/tmp/pfpModules:$HOME/${openshift.jboss.cartridge.type}/tmp/gpseModules

printJvmCount() {
    echo `date` > ~/${openshift.jboss.cartridge.type}/tmp/pre_start_jbosseap-6.0.log
    for jProc in `ps -C java -o pid=`;
    do
        echo "java process id = $jProc\n" >> ~/${openshift.jboss.cartridge.type}/tmp/pre_start_jbosseap-6.0.log
    echo 
}


killExistingJavaProcesses() {
    for jProc in `ps -C java -o pid=`;
    do
        echo -en "about to kill java process id = $jProc\n"
        kill -9 $jProc
    done
}


cleanRuntime() {
    if [ -e $HOME/${openshift.jboss.cartridge.type}/${openshift.jboss.cartridge.type}/standalone/log/server.log ]
    then
        echo -en "cleanRuntime() \n";
        rm $HOME/${openshift.jboss.cartridge.type}/${openshift.jboss.cartridge.type}/standalone/log/server.log
    fi

}

createSoftLinksToWebArchives() {
    cd $OPENSHIFT_REPO_DIR/deployments
    echo -en "createSoftLinksToWebArchives() will now create soft links \n";

    # remove any stale links or status files referencing the brms web archives
    rm -f b*war* d*war* j*war*

    ln -s ~/${openshift.jboss.cartridge.type}/tmp/deployments/${console.server.name}
    touch ${console.server.name}.dodeploy


    ln -s ~/${openshift.jboss.cartridge.type}/tmp/deployments/${console.name}
    touch ${console.name}.dodeploy

    ln -s ~/${openshift.jboss.cartridge.type}/tmp/deployments/${designer.name}
    touch ${designer.name}.dodeploy

    ln -s ~/${openshift.jboss.cartridge.type}/tmp/deployments/${guvnor.name}
    touch ${guvnor.name}.dodeploy
}

printJvmCount
killExistingJavaProcesses
cleanRuntime
createSoftLinksToWebArchives
